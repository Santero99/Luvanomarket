<!DOCTYPE html>
<html lang="pt-MZ">
<head>
  <meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Perfil - Luvano</title>
  <link rel="manifest" href="manifest.json"/>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    :root{--azul:#1877f2;--azul-light:#e7f0ff;--cinza-bg:#f0f2f5;--cinza-borda:#dde1e7;--texto:#1c1e21;--texto-sec:#65676b;--verde:#2e7d32;--vermelho:#e41e3f;}
    *{margin:0;padding:0;box-sizing:border-box;}
    body{font-family:'Segoe UI',system-ui,sans-serif;background:var(--cinza-bg);}
    header{background:var(--azul);padding:0 20px;height:60px;display:flex;align-items:center;justify-content:space-between;}
    header a.logo{color:#fff;font-size:20px;font-weight:800;text-decoration:none;}
    .nav{display:flex;gap:8px;}
    .nav a{color:rgba(255,255,255,.85);text-decoration:none;font-size:14px;padding:6px 12px;border-radius:6px;}
    .nav a:hover{background:rgba(255,255,255,.15);}
    .container{max-width:860px;margin:0 auto;padding:24px 16px;}
    .perfil-header{background:#fff;border-radius:12px;box-shadow:0 2px 12px rgba(0,0,0,.1);overflow:hidden;margin-bottom:20px;}
    .perfil-capa{height:160px;background:linear-gradient(135deg,#1877f2,#0d5ec9);position:relative;}
    .perfil-avatar{position:absolute;bottom:-40px;left:28px;width:90px;height:90px;border-radius:50%;border:4px solid #fff;background:#e7f0ff;display:flex;align-items:center;justify-content:center;font-size:40px;overflow:hidden;box-shadow:0 2px 8px rgba(0,0,0,.15);}
    .perfil-avatar img{width:100%;height:100%;object-fit:cover;}
    .perfil-info{padding:56px 28px 20px;}
    .perfil-nome{font-size:24px;font-weight:800;margin-bottom:4px;}
    .perfil-email{color:var(--texto-sec);font-size:14px;margin-bottom:8px;}
    .perfil-badges{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px;}
    .badge{padding:4px 12px;border-radius:20px;font-size:12px;font-weight:700;}
    .badge-role{background:var(--azul-light);color:var(--azul);}
    .badge-verificado{background:#e8f5e9;color:var(--verde);}
    .perfil-stats{display:flex;gap:24px;margin-top:12px;}
    .stat{text-align:center;}
    .stat-n{font-size:20px;font-weight:900;color:var(--azul);}
    .stat-l{font-size:12px;color:var(--texto-sec);}
    .perfil-acoes{display:flex;gap:10px;margin-top:16px;flex-wrap:wrap;}
    .btn-acao{padding:9px 18px;border-radius:8px;font-size:14px;font-weight:600;cursor:pointer;border:none;text-decoration:none;display:flex;align-items:center;gap:6px;transition:all .2s;}
    .btn-primario{background:var(--azul);color:#fff;}
    .btn-primario:hover{background:#0d5ec9;}
    .btn-sec{background:#fff;color:var(--texto);border:2px solid var(--cinza-borda);}
    .btn-sec:hover{border-color:var(--azul);color:var(--azul);}
    .btn-danger{background:#ffebee;color:var(--vermelho);border:2px solid #ffcdd2;}
    .btn-danger:hover{background:#ffcdd2;}
    .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:16px;}
    @media(max-width:600px){.grid-2{grid-template-columns:1fr;}.perfil-stats{gap:12px;}}
    .card{background:#fff;border-radius:12px;box-shadow:0 2px 12px rgba(0,0,0,.1);padding:22px;}
    .card-titulo{font-size:17px;font-weight:700;margin-bottom:16px;display:flex;align-items:center;gap:8px;}
    .info-row{display:flex;justify-content:space-between;align-items:center;padding:10px 0;border-bottom:1px solid var(--cinza-borda);font-size:14px;}
    .info-row:last-child{border-bottom:none;}
    .info-label{color:var(--texto-sec);}
    .info-val{font-weight:600;}
    .compra-item{display:flex;gap:12px;align-items:center;padding:12px 0;border-bottom:1px solid var(--cinza-borda);}
    .compra-item:last-child{border-bottom:none;}
    .compra-item img{width:56px;height:56px;border-radius:8px;object-fit:cover;flex-shrink:0;}
    .compra-nm{font-weight:700;font-size:14px;}
    .compra-meta{font-size:12px;color:var(--texto-sec);margin-top:2px;}
    .compra-val{font-size:16px;font-weight:800;color:var(--azul);margin-left:auto;}
    #toast{position:fixed;bottom:20px;left:50%;transform:translateX(-50%) translateY(80px);background:#323232;color:#fff;padding:12px 24px;border-radius:30px;font-size:14px;z-index:9999;transition:transform .3s;}
    #toast.show{transform:translateX(-50%) translateY(0);}
  </style>
</head>
<body>
<header>
  <a class="logo" href="index.html">üõçÔ∏è Luvano</a>
  <div class="nav">
    <a href="index.html">üè† In√≠cio</a>
    <a href="notificacoes.html">üîî</a>
    <a href="configuracoes.html">‚öôÔ∏è</a>
  </div>
</header>
<div class="container">
  <div class="perfil-header">
    <div class="perfil-capa"></div>
    <div class="perfil-info">
      <div class="perfil-avatar" id="avatarEl">üë§</div>
      <div class="perfil-nome" id="nomeEl">Carregando...</div>
      <div class="perfil-email" id="emailEl"></div>
      <div class="perfil-badges">
        <span class="badge badge-role" id="roleBadge">Cliente</span>
        <span class="badge badge-verificado">‚úÖ Verificado</span>
      </div>
      <div class="perfil-stats">
        <div class="stat"><div class="stat-n" id="nCompras">0</div><div class="stat-l">Compras</div></div>
        <div class="stat"><div class="stat-n" id="nProdutos">0</div><div class="stat-l">Produtos</div></div>
        <div class="stat"><div class="stat-n" id="nFavs">0</div><div class="stat-l">Favoritos</div></div>
      </div>
      <div class="perfil-acoes">
        <a href="editar-perfil.html" class="btn-acao btn-primario">‚úèÔ∏è Editar Perfil</a>
        <a href="carteira.html" class="btn-acao btn-sec">üí≥ Carteira</a>
        <a href="vendedor.html" class="btn-acao btn-sec">üíº Painel Vendedor</a>
        <button class="btn-acao btn-danger" onclick="logout()">üö™ Sair</button>
      </div>
    </div>
  </div>

  <div class="grid-2">
    <div class="card">
      <div class="card-titulo">üë§ Informa√ß√µes Pessoais</div>
      <div class="info-row"><span class="info-label">Nome</span><span class="info-val" id="infoNome">-</span></div>
      <div class="info-row"><span class="info-label">Email</span><span class="info-val" id="infoEmail">-</span></div>
      <div class="info-row"><span class="info-label">Telem√≥vel</span><span class="info-val" id="infoTel">-</span></div>
      <div class="info-row"><span class="info-label">Tipo de conta</span><span class="info-val" id="infoRol">-</span></div>
      <div class="info-row"><span class="info-label">Membro desde</span><span class="info-val" id="infoData">-</span></div>
    </div>
    <div class="card">
      <div class="card-titulo">üîó Links R√°pidos</div>
      <div style="display:flex;flex-direction:column;gap:10px;">
        <a href="compras.html" style="display:flex;align-items:center;gap:10px;padding:12px;background:var(--cinza-bg);border-radius:8px;text-decoration:none;color:var(--texto);font-weight:600;font-size:14px;">üì¶ Minhas Compras</a>
        <a href="favoritos.html" style="display:flex;align-items:center;gap:10px;padding:12px;background:var(--cinza-bg);border-radius:8px;text-decoration:none;color:var(--texto);font-weight:600;font-size:14px;">‚ù§Ô∏è Favoritos</a>
        <a href="meus-produtos.html" style="display:flex;align-items:center;gap:10px;padding:12px;background:var(--cinza-bg);border-radius:8px;text-decoration:none;color:var(--texto);font-weight:600;font-size:14px;">üè™ Meus Produtos</a>
        <a href="conversas.html" style="display:flex;align-items:center;gap:10px;padding:12px;background:var(--cinza-bg);border-radius:8px;text-decoration:none;color:var(--texto);font-weight:600;font-size:14px;">üí¨ Mensagens</a>
        <a href="notificacoes.html" style="display:flex;align-items:center;gap:10px;padding:12px;background:var(--cinza-bg);border-radius:8px;text-decoration:none;color:var(--texto);font-weight:600;font-size:14px;">üîî Notifica√ß√µes</a>
      </div>
    </div>
  </div>

  <div class="card" style="margin-top:16px">
    <div class="card-titulo">üõí Compras Recentes</div>
    <div id="comprasLista"><div style="text-align:center;padding:24px;color:var(--texto-sec)">A carregar...</div></div>
  </div>
</div>
<div id="toast"></div>
<script>
const SUPABASE_URL='https://SEU_PROJETO.supabase.co';
const SUPABASE_ANON_KEY='SUA_ANON_KEY_AQUI';
const {createClient}=supabase;
const sb=createClient(SUPABASE_URL,SUPABASE_ANON_KEY);
let usuario=null;

document.addEventListener('DOMContentLoaded',async()=>{
  const {data:{session}}=await sb.auth.getSession();
  if(!session){window.location.href='login.html';return;}
  usuario=session.user;
  await carregarPerfil();
});

async function carregarPerfil(){
  const {data:p}=await sb.from('users').select('*').eq('id',usuario.id).single();
  if(p){
    document.getElementById('nomeEl').textContent=p.nome||'Utilizador';
    document.getElementById('emailEl').textContent=p.email||usuario.email;
    document.getElementById('roleBadge').textContent=p.rol==='vendedor'?'üè™ Vendedor':p.rol==='admin'?'üõ°Ô∏è Admin':'üõí Cliente';
    document.getElementById('infoNome').textContent=p.nome||'-';
    document.getElementById('infoEmail').textContent=p.email||usuario.email||'-';
    document.getElementById('infoTel').textContent=p.telefone||'-';
    document.getElementById('infoRol').textContent=p.rol||'cliente';
    document.getElementById('infoData').textContent=p.criado_em?new Date(p.criado_em).toLocaleDateString('pt-MZ'):'-';
    if(p.avatar)document.getElementById('avatarEl').innerHTML=`<img src="${p.avatar}" alt="Avatar"/>`;
  }
  const [{count:nC},{count:nP},{count:nF}]=await Promise.all([
    sb.from('pagamentos').select('*',{count:'exact',head:true}).eq('usuario_id',usuario.id).eq('status','confirmado'),
    sb.from('produtos').select('*',{count:'exact',head:true}).eq('vendedor_id',usuario.id).eq('ativo',true),
    sb.from('favoritos').select('*',{count:'exact',head:true}).eq('usuario_id',usuario.id)
  ]);
  document.getElementById('nCompras').textContent=nC||0;
  document.getElementById('nProdutos').textContent=nP||0;
  document.getElementById('nFavs').textContent=nF||0;
  await carregarCompras();
}

async function carregarCompras(){
  const {data}=await sb.from('pagamentos').select('*,produtos(nome,fotos,preco)').eq('usuario_id',usuario.id).eq('status','confirmado').order('criado_em',{ascending:false}).limit(4);
  const el=document.getElementById('comprasLista');
  const demo=[{produtos:{nome:'iPhone 14 Pro 256GB',fotos:'["https://images.unsplash.com/photo-1695048133142-1a20484d2569?w=80&q=80"]',preco:65000},metodo:'mpesa',criado_em:new Date().toISOString(),valor:65000}];
  const lista=(data&&data.length)?data:demo;
  el.innerHTML=lista.map(c=>{
    const f=c.produtos?.fotos?JSON.parse(c.produtos.fotos):[];
    return `<div class="compra-item">
      <img src="${f[0]||'https://via.placeholder.com/56'}" alt="${c.produtos?.nome}" onerror="this.src='https://via.placeholder.com/56'"/>
      <div>
        <div class="compra-nm">${c.produtos?.nome||'Produto'}</div>
        <div class="compra-meta">${c.metodo?.toUpperCase()||'Pagamento'} ¬∑ ${new Date(c.criado_em).toLocaleDateString('pt-MZ')}</div>
      </div>
      <div class="compra-val">MT ${Number(c.valor||c.produtos?.preco||0).toLocaleString('pt-MZ')}</div>
    </div>`;}).join('')+'<div style="text-align:center;margin-top:12px"><a href="compras.html" style="color:var(--azul);font-weight:600;font-size:14px">Ver todas as compras ‚Üí</a></div>';
}

async function logout(){
  await sb.auth.signOut();
  window.location.href='login.html';
}

function mostrarToast(msg,tipo='info'){
  const t=document.getElementById('toast');
  t.textContent=msg;t.style.background=tipo==='erro'?'#c62828':tipo==='sucesso'?'#2e7d32':'#323232';
  t.classList.add('show');setTimeout(()=>t.classList.remove('show'),3000);
}
</script>

<script>
if ("serviceWorker" in navigator) {
  window.addEventListener("load", () => {
    navigator.serviceWorker.register("/service-worker.js")
      .then(r => console.log("[Luvano SW] Registado:", r.scope))
      .catch(e => console.warn("[Luvano SW] Erro:", e));
  });
}
</script>
</body>
</html>
