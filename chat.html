<!DOCTYPE html>
<html lang="pt-MZ">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Chat - Luvano</title>
  <link rel="manifest" href="manifest.json"/>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    :root {
      --azul: #1877f2; --azul-dark: #0d5ec9; --azul-light: #e7f0ff;
      --cinza-bg: #f0f2f5; --cinza-borda: #dde1e7;
      --texto: #1c1e21; --texto-sec: #65676b; --verde: #25D366;
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Segoe UI', system-ui, sans-serif; background: var(--cinza-bg); display: flex; flex-direction: column; height: 100vh; }
    header { background: var(--azul); padding: 0 16px; height: 60px; display: flex; align-items: center; gap: 12px; flex-shrink: 0; box-shadow: 0 2px 8px rgba(24,119,242,0.4); }
    .btn-back { color: #fff; background: none; border: none; font-size: 22px; cursor: pointer; padding: 8px; }
    .contato-info { flex: 1; display: flex; align-items: center; gap: 10px; }
    .contato-avatar { width: 40px; height: 40px; border-radius: 50%; background: rgba(255,255,255,0.3); display: flex; align-items: center; justify-content: center; font-size: 20px; overflow: hidden; }
    .contato-avatar img { width: 100%; height: 100%; object-fit: cover; }
    .contato-nome { color: #fff; font-weight: 700; font-size: 16px; }
    .contato-status { color: rgba(255,255,255,0.8); font-size: 12px; }
    .btn-wa { background: var(--verde); color: #fff; border: none; border-radius: 8px; padding: 8px 14px; cursor: pointer; font-size: 13px; font-weight: 600; display: flex; align-items: center; gap: 6px; text-decoration: none; }

    /* PRODUTO CARD NO CHAT */
    .produto-mini { background: #fff; border-bottom: 1px solid var(--cinza-borda); padding: 10px 16px; display: flex; align-items: center; gap: 10px; cursor: pointer; flex-shrink: 0; }
    .produto-mini img { width: 48px; height: 48px; object-fit: cover; border-radius: 8px; }
    .produto-mini-nome { font-size: 14px; font-weight: 600; }
    .produto-mini-preco { font-size: 16px; font-weight: 800; color: var(--azul); }

    /* MENSAGENS */
    .chat-area { flex: 1; overflow-y: auto; padding: 16px; display: flex; flex-direction: column; gap: 8px; }
    .msg-wrap { display: flex; max-width: 70%; }
    .msg-wrap.minha { align-self: flex-end; flex-direction: row-reverse; }
    .msg-wrap.dele { align-self: flex-start; }
    .msg-avatar { width: 30px; height: 30px; border-radius: 50%; background: var(--cinza-borda); display: flex; align-items: center; justify-content: center; font-size: 14px; flex-shrink: 0; margin: 0 6px; align-self: flex-end; }
    .msg-balao { padding: 10px 14px; border-radius: 18px; max-width: 100%; }
    .msg-wrap.minha .msg-balao { background: var(--azul); color: #fff; border-bottom-right-radius: 4px; }
    .msg-wrap.dele .msg-balao { background: #fff; color: var(--texto); border-bottom-left-radius: 4px; box-shadow: 0 1px 4px rgba(0,0,0,0.1); }
    .msg-txt { font-size: 15px; line-height: 1.5; }
    .msg-hora { font-size: 11px; margin-top: 4px; opacity: 0.7; text-align: right; }
    .msg-wrap.dele .msg-hora { text-align: left; }

    /* SISTEMA */
    .msg-sistema { text-align: center; padding: 6px 16px; font-size: 12px; color: var(--texto-sec); background: rgba(0,0,0,0.05); border-radius: 20px; margin: 4px auto; }

    /* INPUT */
    .chat-input-area { background: #fff; border-top: 1px solid var(--cinza-borda); padding: 12px 16px; display: flex; gap: 10px; align-items: flex-end; flex-shrink: 0; }
    .input-wrap { flex: 1; background: var(--cinza-bg); border-radius: 24px; padding: 10px 16px; display: flex; align-items: center; gap: 8px; min-height: 44px; }
    .input-wrap textarea { flex: 1; background: none; border: none; outline: none; font-size: 15px; font-family: inherit; resize: none; max-height: 120px; line-height: 1.4; }
    .btn-enviar { background: var(--azul); color: #fff; border: none; border-radius: 50%; width: 44px; height: 44px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 20px; transition: background 0.2s; flex-shrink: 0; }
    .btn-enviar:hover { background: var(--azul-dark); }
    .btn-enviar:disabled { background: #9fb8e8; cursor: not-allowed; }

    /* DIGITANDO */
    .digitando { display: none; padding: 6px 16px; font-size: 13px; color: var(--texto-sec); font-style: italic; }
    .digitando.show { display: block; }

    /* VAZIO */
    .chat-vazio { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; color: var(--texto-sec); gap: 12px; }
    .chat-vazio .icon { font-size: 64px; }

    #toast { position: fixed; bottom: 80px; left: 50%; transform: translateX(-50%) translateY(80px); background: #323232; color: #fff; padding: 10px 20px; border-radius: 20px; font-size: 13px; z-index: 999; transition: transform 0.3s; }
    #toast.show { transform: translateX(-50%) translateY(0); }
  </style>
</head>
<body>

<header>
  <button class="btn-back" onclick="history.back()">‚Üê</button>
  <div class="contato-info" id="contatoInfo">
    <div class="contato-avatar">üë§</div>
    <div>
      <div class="contato-nome">A carregar...</div>
    </div>
  </div>
  <a href="#" class="btn-wa" id="btnWA" target="_blank">
    <svg width="16" height="16" fill="white" viewBox="0 0 24 24"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413z"/><path d="M12 0C5.373 0 0 5.373 0 12c0 2.123.558 4.118 1.534 5.848L.058 24l6.305-1.654A11.93 11.93 0 0012 24c6.627 0 12-5.373 12-12S18.627 0 12 0zm0 22c-1.891 0-3.659-.506-5.181-1.388l-.37-.22-3.745.982.999-3.652-.24-.38A9.938 9.938 0 012 12C2 6.477 6.477 2 12 2s10 4.477 10 10-4.477 10-10 10z"/></svg>
    WhatsApp
  </a>
</header>

<!-- Produto mini card -->
<div class="produto-mini" id="produtoMini" style="display:none">
  <img src="" id="prodMiniImg" alt="Produto" />
  <div>
    <div class="produto-mini-nome" id="prodMiniNome">Produto</div>
    <div class="produto-mini-preco" id="prodMiniPreco"></div>
  </div>
  <button onclick="window.location.href='produto.html?id='+produtoId" style="margin-left:auto;background:var(--azul-light);color:var(--azul);border:none;border-radius:6px;padding:6px 12px;cursor:pointer;font-size:12px;font-weight:600">Ver Produto</button>
</div>

<!-- √Årea mensagens -->
<div class="chat-area" id="chatArea">
  <div class="chat-vazio" id="chatVazio">
    <div class="icon">üí¨</div>
    <p>Inicie a conversa sobre o produto</p>
  </div>
</div>

<div class="digitando" id="digitando">O contacto est√° a escrever...</div>

<!-- Input -->
<div class="chat-input-area">
  <div class="input-wrap">
    <textarea id="msgInput" placeholder="Escreva uma mensagem..." rows="1" onkeydown="if(event.key==='Enter'&&!event.shiftKey){event.preventDefault();enviarMsg()}" oninput="autoResize(this)"></textarea>
  </div>
  <button class="btn-enviar" onclick="enviarMsg()" id="btnEnviar">
    ‚û§
  </button>
</div>

<div id="toast"></div>

<script>
const SUPABASE_URL = 'https://SEU_PROJETO.supabase.co';
const SUPABASE_ANON_KEY = 'SUA_ANON_KEY_AQUI';
const { createClient } = supabase;
const sb = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

const params = new URLSearchParams(window.location.search);
const vendedorId = params.get('vendedor');
const produtoId = params.get('produto');

let usuario = null;
let conversa = null;
let outroUser = null;
let mensagemSubscription = null;

const MSGS_DEMO = [
  { id: 1, remetente_id: 'outro', texto: 'Ol√°! Estou interessado no produto. Ainda est√° dispon√≠vel?', criado_em: new Date(Date.now() - 300000).toISOString() },
  { id: 2, remetente_id: 'eu', texto: 'Sim, ainda est√° dispon√≠vel! O que gostaria de saber?', criado_em: new Date(Date.now() - 240000).toISOString() },
  { id: 3, remetente_id: 'outro', texto: 'Aceita negocia√ß√£o no pre√ßo? Posso pagar √† vista via M-Pesa.', criado_em: new Date(Date.now() - 180000).toISOString() },
  { id: 4, remetente_id: 'eu', texto: 'Podemos negociar sim. Qual valor est√° a pensar?', criado_em: new Date(Date.now() - 120000).toISOString() },
];

document.addEventListener('DOMContentLoaded', async () => {
  const { data: { session } } = await sb.auth.getSession();
  if (!session) { window.location.href = 'login.html'; return; }
  usuario = session.user;
  await carregarDados();
});

async function carregarDados() {
  // Carregar info do outro utilizador (vendedor/comprador)
  if (vendedorId) {
    const { data } = await sb.from('users').select('*').eq('id', vendedorId).single();
    outroUser = data;
  }

  // Actualizar header
  const info = document.getElementById('contatoInfo');
  if (outroUser) {
    info.innerHTML = `
      <div class="contato-avatar">${outroUser.avatar ? `<img src="${outroUser.avatar}">` : 'üë§'}</div>
      <div>
        <div class="contato-nome">${outroUser.nome || 'Utilizador'}</div>
        <div class="contato-status">üü¢ Online</div>
      </div>`;
    // WhatsApp link
    const tel = (outroUser.telefone || '').replace(/\D/g,'');
    if (tel) document.getElementById('btnWA').href = `https://wa.me/${tel}`;
  }

  // Carregar produto
  if (produtoId) {
    const { data: prod } = await sb.from('produtos').select('*').eq('id', produtoId).single();
    if (prod) {
      const fotos = typeof prod.fotos === 'string' ? JSON.parse(prod.fotos) : (prod.fotos || []);
      document.getElementById('produtoMini').style.display = 'flex';
      document.getElementById('prodMiniImg').src = fotos[0] || '';
      document.getElementById('prodMiniNome').textContent = prod.nome;
      document.getElementById('prodMiniPreco').textContent = `MT ${Number(prod.preco).toLocaleString('pt-MZ')}`;
    }
  }

  // Buscar ou criar conversa
  await encontrarConversa();
  await carregarMensagens();
  assinarMensagens();
}

async function encontrarConversa() {
  if (!vendedorId) return;
  // Procurar conversa existente
  const { data } = await sb.from('conversas').select('*')
    .or(`and(usuario1.eq.${usuario.id},usuario2.eq.${vendedorId}),and(usuario1.eq.${vendedorId},usuario2.eq.${usuario.id})`)
    .single();
  
  if (data) {
    conversa = data;
  } else {
    // Criar nova conversa
    const { data: nova } = await sb.from('conversas').insert({
      usuario1: usuario.id,
      usuario2: vendedorId,
      produto_id: produtoId,
      data: new Date().toISOString()
    }).select().single();
    conversa = nova;
  }
}

async function carregarMensagens() {
  const area = document.getElementById('chatArea');
  area.innerHTML = '';

  let msgs = [];

  if (conversa) {
    const { data } = await sb.from('mensagens').select('*').eq('conversa_id', conversa.id).order('criado_em', { ascending: true });
    msgs = data || [];
  }

  // Usar demo se vazio
  if (msgs.length === 0) {
    MSGS_DEMO.forEach(m => {
      const ehMinha = m.remetente_id === 'eu';
      area.appendChild(criarMensagem({ ...m, remetente_id: ehMinha ? usuario.id : (vendedorId || 'outro') }));
    });
  } else {
    msgs.forEach(m => area.appendChild(criarMensagem(m)));
  }

  scrollBaixo();
}

function criarMensagem(msg) {
  const ehMinha = msg.remetente_id === usuario?.id;
  const hora = new Date(msg.criado_em).toLocaleTimeString('pt-MZ', { hour: '2-digit', minute: '2-digit' });
  const div = document.createElement('div');
  div.className = `msg-wrap ${ehMinha ? 'minha' : 'dele'}`;
  div.id = `msg-${msg.id}`;
  div.innerHTML = `
    ${!ehMinha ? `<div class="msg-avatar">${outroUser?.avatar ? `<img src="${outroUser.avatar}" style="width:100%;height:100%;object-fit:cover;border-radius:50%">` : 'üë§'}</div>` : ''}
    <div class="msg-balao">
      <div class="msg-txt">${msg.texto}</div>
      <div class="msg-hora">${hora} ${ehMinha ? '‚úì‚úì' : ''}</div>
    </div>
    ${ehMinha ? '<div class="msg-avatar">üßë</div>' : ''}`;
  return div;
}

async function enviarMsg() {
  const inp = document.getElementById('msgInput');
  const texto = inp.value.trim();
  if (!texto) return;

  inp.value = '';
  inp.style.height = 'auto';

  const msg = {
    conversa_id: conversa?.id,
    remetente_id: usuario.id,
    texto,
    criado_em: new Date().toISOString()
  };

  // Mostrar imediatamente
  const area = document.getElementById('chatArea');
  document.getElementById('chatVazio').style.display = 'none';
  area.appendChild(criarMensagem({ ...msg, id: Date.now() }));
  scrollBaixo();

  // Salvar no Supabase
  if (conversa) {
    const { data } = await sb.from('mensagens').insert(msg).select().single();
    // Actualizar √∫ltima mensagem da conversa
    await sb.from('conversas').update({ ultimo_mensagem: texto, data: new Date().toISOString() }).eq('id', conversa.id);
    // Notificar destinat√°rio
    await sb.from('notificacoes').insert({
      usuario_id: vendedorId,
      tipo: 'mensagem',
      mensagem: `Nova mensagem: ${texto.substring(0,50)}`,
      visto: false,
      data: new Date().toISOString()
    });
  }
}

// Subscrever mensagens em tempo real
function assinarMensagens() {
  if (!conversa) return;
  mensagemSubscription = sb.channel(`mensagens-${conversa.id}`)
    .on('postgres_changes', {
      event: 'INSERT', schema: 'public', table: 'mensagens',
      filter: `conversa_id=eq.${conversa.id}`
    }, payload => {
      if (payload.new.remetente_id !== usuario.id) {
        document.getElementById('chatArea').appendChild(criarMensagem(payload.new));
        scrollBaixo();
      }
    })
    .subscribe();
}

function scrollBaixo() {
  const area = document.getElementById('chatArea');
  area.scrollTop = area.scrollHeight;
}

function autoResize(el) {
  el.style.height = 'auto';
  el.style.height = Math.min(el.scrollHeight, 120) + 'px';
}

function mostrarToast(msg, tipo='info') {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.style.background = tipo==='erro'?'#c62828':tipo==='sucesso'?'#2e7d32':'#323232';
  t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 3000);
}
</script>

<script>
if ("serviceWorker" in navigator) {
  window.addEventListener("load", () => {
    navigator.serviceWorker.register("/service-worker.js")
      .then(r => console.log("[Luvano SW] Registado:", r.scope))
      .catch(e => console.warn("[Luvano SW] Erro:", e));
  });
}
</script>
</body>
</html>
