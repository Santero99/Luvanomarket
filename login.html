<!DOCTYPE html>
<html lang="pt-MZ">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Login - Luvano</title>
  <link rel="manifest" href="manifest.json"/>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    :root {
      --azul: #1877f2; --azul-dark: #0d5ec9; --azul-light: #e7f0ff;
      --cinza-bg: #f0f2f5; --cinza-borda: #dde1e7;
      --texto: #1c1e21; --texto-sec: #65676b;
      --vermelho: #e41e3f; --sombra: 0 4px 20px rgba(0,0,0,0.12);
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Segoe UI', system-ui, sans-serif; background: var(--cinza-bg); min-height: 100vh; display: flex; flex-direction: column; }
    header { background: var(--azul); padding: 16px 24px; }
    header a { color: #fff; text-decoration: none; font-size: 22px; font-weight: 800; display: flex; align-items: center; gap: 8px; width: fit-content; }
    .page-wrap { flex: 1; display: flex; align-items: center; justify-content: center; padding: 32px 16px; }
    .card { background: #fff; border-radius: 12px; box-shadow: var(--sombra); width: 100%; max-width: 440px; padding: 36px; }
    .card-titulo { font-size: 26px; font-weight: 800; margin-bottom: 6px; }
    .card-sub { color: var(--texto-sec); font-size: 15px; margin-bottom: 28px; }
    .form-group { margin-bottom: 18px; }
    label { display: block; font-size: 14px; font-weight: 600; margin-bottom: 6px; }
    input { width: 100%; padding: 13px 16px; border: 2px solid var(--cinza-borda); border-radius: 10px; font-size: 15px; outline: none; transition: border-color 0.2s; }
    input:focus { border-color: var(--azul); }
    input.erro { border-color: var(--vermelho); }
    .input-wrap { position: relative; }
    .input-wrap input { padding-right: 48px; }
    .toggle-senha { position: absolute; right: 14px; top: 50%; transform: translateY(-50%); background: none; border: none; cursor: pointer; font-size: 20px; color: var(--texto-sec); }
    .btn-primary { width: 100%; background: var(--azul); color: #fff; border: none; border-radius: 10px; padding: 14px; font-size: 16px; font-weight: 700; cursor: pointer; transition: background 0.2s; display: flex; align-items: center; justify-content: center; gap: 8px; }
    .btn-primary:hover { background: var(--azul-dark); }
    .btn-primary:disabled { background: #9fb8e8; cursor: not-allowed; }
    .btn-google { width: 100%; background: #fff; color: var(--texto); border: 2px solid var(--cinza-borda); border-radius: 10px; padding: 13px; font-size: 15px; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px; transition: all 0.2s; }
    .btn-google:hover { border-color: var(--azul); background: var(--azul-light); }
    .divider { display: flex; align-items: center; gap: 12px; margin: 20px 0; }
    .divider hr { flex: 1; border: none; border-top: 1px solid var(--cinza-borda); }
    .divider span { color: var(--texto-sec); font-size: 13px; }
    .link-cadastro { text-align: center; margin-top: 20px; font-size: 14px; color: var(--texto-sec); }
    .link-cadastro a { color: var(--azul); font-weight: 600; text-decoration: none; }
    .forgot { text-align: right; margin-top: -10px; margin-bottom: 16px; }
    .forgot a { color: var(--azul); font-size: 13px; text-decoration: none; }
    .spinner { width: 20px; height: 20px; border: 3px solid rgba(255,255,255,0.4); border-top-color: #fff; border-radius: 50%; animation: spin 0.6s linear infinite; display: none; }
    @keyframes spin { to { transform: rotate(360deg); } }
    #toast { position: fixed; top: 20px; left: 50%; transform: translateX(-50%) translateY(-80px); padding: 12px 24px; border-radius: 30px; font-size: 14px; font-weight: 600; z-index: 9999; transition: transform 0.3s; color: #fff; box-shadow: 0 4px 16px rgba(0,0,0,0.2); }
    #toast.show { transform: translateX(-50%) translateY(0); }
    .luvano-brand { text-align: center; margin-bottom: 28px; }
    .luvano-brand .logo-big { font-size: 52px; margin-bottom: 8px; }
    .luvano-brand h1 { font-size: 32px; font-weight: 900; color: var(--azul); letter-spacing: -1px; }
    .luvano-brand p { color: var(--texto-sec); font-size: 15px; margin-top: 4px; }
    .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; z-index: 999; }
    .modal-overlay.show { display: flex; }
    .modal { background: #fff; border-radius: 12px; padding: 28px; width: 90%; max-width: 380px; }
    .modal h3 { margin-bottom: 12px; }
    .modal input { width: 100%; padding: 12px; border: 2px solid var(--cinza-borda); border-radius: 8px; font-size: 15px; outline: none; margin-bottom: 12px; }
    .modal input:focus { border-color: var(--azul); }
    .modal-btns { display: flex; gap: 10px; }
    .modal-btns button { flex: 1; padding: 11px; border-radius: 8px; font-weight: 700; cursor: pointer; }
    .btn-cancel { background: var(--cinza-bg); border: none; color: var(--texto); }
    .btn-confirm { background: var(--azul); border: none; color: #fff; }
  </style>
</head>
<body>
<header>
  <a href="index.html">üõçÔ∏è Luvano</a>
</header>

<div class="page-wrap">
  <div class="card">
    <div class="luvano-brand">
      <div class="logo-big">üõçÔ∏è</div>
      <h1>Luvano</h1>
      <p>Marketplace de Mo√ßambique</p>
    </div>

    <div class="form-group">
      <label>Email</label>
      <input type="email" id="email" placeholder="seu@email.com" onkeydown="if(event.key==='Enter')login()" />
    </div>
    <div class="form-group">
      <label>Senha</label>
      <div class="input-wrap">
        <input type="password" id="senha" placeholder="A sua senha" onkeydown="if(event.key==='Enter')login()" />
        <button type="button" class="toggle-senha" onclick="toggleVer()">üëÅÔ∏è</button>
      </div>
    </div>
    <div class="forgot">
      <a href="#" onclick="abrirRecuperar()">Esqueceu a senha?</a>
    </div>

    <button class="btn-primary" onclick="login()" id="btnLogin">
      Iniciar Sess√£o <div class="spinner" id="spin"></div>
    </button>

    <div class="divider"><hr><span>ou</span><hr></div>

    <button class="btn-google" onclick="loginGoogle()">
      <svg width="20" height="20" viewBox="0 0 24 24">
        <path fill="#4285f4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
        <path fill="#34a853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
        <path fill="#fbbc05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
        <path fill="#ea4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.47 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
      </svg>
      Continuar com Google
    </button>

    <div class="link-cadastro">
      N√£o tem conta? <a href="cadastro.html">Criar Conta Gr√°tis</a>
    </div>
  </div>
</div>

<!-- Modal Recuperar Senha -->
<div class="modal-overlay" id="modalRecuperar">
  <div class="modal">
    <h3>üîë Recuperar Senha</h3>
    <p style="color:var(--texto-sec);font-size:13px;margin-bottom:14px">Insira o seu email para receber as instru√ß√µes de recupera√ß√£o.</p>
    <input type="email" id="emailRecuperar" placeholder="seu@email.com" />
    <div class="modal-btns">
      <button class="btn-cancel" onclick="fecharModal()">Cancelar</button>
      <button class="btn-confirm" onclick="enviarRecuperacao()">Enviar</button>
    </div>
  </div>
</div>

<div id="toast"></div>

<script>
const SUPABASE_URL = 'https://SEU_PROJETO.supabase.co';
const SUPABASE_ANON_KEY = 'SUA_ANON_KEY_AQUI';
const { createClient } = supabase;
const sb = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

// Verificar se j√° est√° logado
document.addEventListener('DOMContentLoaded', async () => {
  const { data: { session } } = await sb.auth.getSession();
  if (session) window.location.href = 'index.html';
});

async function login() {
  const email = document.getElementById('email').value.trim();
  const senha = document.getElementById('senha').value;

  if (!email || !senha) { mostrarToast('Preencha email e senha', 'erro'); return; }

  setLoading(true);

  const { data, error } = await sb.auth.signInWithPassword({ email, password: senha });

  setLoading(false);

  if (error) {
    if (error.message.includes('Invalid login credentials')) {
      mostrarToast('Email ou senha incorretos', 'erro');
    } else if (error.message.includes('Email not confirmed')) {
      mostrarToast('Email n√£o verificado. Verifique a sua caixa de entrada.', 'erro');
    } else {
      mostrarToast(error.message, 'erro');
    }
    document.getElementById('email').classList.add('erro');
    document.getElementById('senha').classList.add('erro');
    return;
  }

  // Verificar se √© admin ‚Üí redirecionar
  const { data: perfil } = await sb.from('users').select('rol').eq('id', data.user.id).single();
  mostrarToast('Login feito com sucesso!', 'sucesso');
  
  setTimeout(() => {
    const redirect = new URLSearchParams(window.location.search).get('next') || 'index.html';
    window.location.href = perfil?.rol === 'admin' ? 'admin.html' : redirect;
  }, 800);
}

async function loginGoogle() {
  const { error } = await sb.auth.signInWithOAuth({
    provider: 'google',
    options: { redirectTo: window.location.origin + '/index.html' }
  });
  if (error) mostrarToast('Erro com Google: ' + error.message, 'erro');
}

function toggleVer() {
  const inp = document.getElementById('senha');
  const btn = document.querySelector('.toggle-senha');
  inp.type = inp.type === 'password' ? 'text' : 'password';
  btn.textContent = inp.type === 'password' ? 'üëÅÔ∏è' : 'üôà';
}

function abrirRecuperar() {
  document.getElementById('modalRecuperar').classList.add('show');
}
function fecharModal() {
  document.getElementById('modalRecuperar').classList.remove('show');
}

async function enviarRecuperacao() {
  const email = document.getElementById('emailRecuperar').value.trim();
  if (!email) { mostrarToast('Insira o seu email', 'erro'); return; }
  const { error } = await sb.auth.resetPasswordForEmail(email, {
    redirectTo: window.location.origin + '/configuracoes.html?reset=1'
  });
  if (error) { mostrarToast('Erro: ' + error.message, 'erro'); return; }
  fecharModal();
  mostrarToast('Email de recupera√ß√£o enviado!', 'sucesso');
}

function setLoading(on) {
  const btn = document.getElementById('btnLogin');
  const sp = document.getElementById('spin');
  btn.disabled = on;
  sp.style.display = on ? 'block' : 'none';
  btn.childNodes[0].textContent = on ? ' A processar...' : ' Iniciar Sess√£o ';
}

function mostrarToast(msg, tipo = 'info') {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.style.background = tipo === 'erro' ? '#c62828' : tipo === 'sucesso' ? '#2e7d32' : '#323232';
  t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 3500);
}
</script>

<script>
if ("serviceWorker" in navigator) {
  window.addEventListener("load", () => {
    navigator.serviceWorker.register("/service-worker.js")
      .then(r => console.log("[Luvano SW] Registado:", r.scope))
      .catch(e => console.warn("[Luvano SW] Erro:", e));
  });
}
</script>
</body>
</html>
