<!DOCTYPE html>
<html lang="pt-MZ">
<head>
  <meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Mensagens - Luvano</title>
  <link rel="manifest" href="manifest.json"/>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    :root{--azul:#1877f2;--azul-light:#e7f0ff;--cinza-bg:#f0f2f5;--cinza-borda:#dde1e7;--texto:#1c1e21;--texto-sec:#65676b;--verde:#2e7d32;}
    *{margin:0;padding:0;box-sizing:border-box;}
    body{font-family:'Segoe UI',system-ui,sans-serif;background:var(--cinza-bg);}
    header{background:var(--azul);padding:0 20px;height:60px;display:flex;align-items:center;justify-content:space-between;}
    header a.logo{color:#fff;font-size:20px;font-weight:800;text-decoration:none;}
    .btn-h{color:#fff;background:rgba(255,255,255,.2);border:none;border-radius:8px;padding:8px 14px;cursor:pointer;text-decoration:none;font-size:14px;}
    .container{max-width:680px;margin:0 auto;padding:24px 16px;}
    .page-titulo{font-size:22px;font-weight:800;margin-bottom:20px;}
    .busca{background:#fff;border-radius:10px;display:flex;align-items:center;gap:10px;padding:10px 14px;margin-bottom:16px;box-shadow:0 1px 4px rgba(0,0,0,.07);}
    .busca input{flex:1;border:none;outline:none;font-size:15px;}
    .conv-item{background:#fff;border-radius:12px;box-shadow:0 1px 4px rgba(0,0,0,.07);padding:14px 16px;margin-bottom:8px;display:flex;gap:12px;align-items:center;cursor:pointer;transition:all .2s;}
    .conv-item:hover{box-shadow:0 4px 12px rgba(0,0,0,.12);transform:translateY(-1px);}
    .conv-item.nao-lida{border-left:4px solid var(--azul);background:linear-gradient(to right,#f0f6ff,#fff);}
    .conv-avatar{width:52px;height:52px;border-radius:50%;background:var(--azul-light);display:flex;align-items:center;justify-content:center;font-size:22px;flex-shrink:0;overflow:hidden;}
    .conv-avatar img{width:100%;height:100%;object-fit:cover;}
    .conv-info{flex:1;min-width:0;}
    .conv-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:3px;}
    .conv-nm{font-weight:700;font-size:15px;}
    .conv-time{font-size:12px;color:var(--texto-sec);}
    .conv-msg{font-size:13px;color:var(--texto-sec);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
    .conv-msg.bold{color:var(--texto);font-weight:600;}
    .badge-unread{background:var(--azul);color:#fff;border-radius:50%;min-width:20px;height:20px;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;margin-left:8px;}
    .vazio{text-align:center;padding:80px 24px;color:var(--texto-sec);}
  </style>
</head>
<body>
<header>
  <a class="logo" href="index.html">üõçÔ∏è Luvano</a>
  <a href="index.html" class="btn-h">üè† In√≠cio</a>
</header>
<div class="container">
  <div class="page-titulo">üí¨ Mensagens</div>
  <div class="busca">
    <span>üîç</span>
    <input type="text" placeholder="Pesquisar conversas..." oninput="filtrarConversas(this.value)"/>
  </div>
  <div id="lista"><div style="text-align:center;padding:40px;color:var(--texto-sec)">A carregar...</div></div>
</div>
<script>
const SUPABASE_URL='https://SEU_PROJETO.supabase.co';
const SUPABASE_ANON_KEY='SUA_ANON_KEY_AQUI';
const {createClient}=supabase;
const sb=createClient(SUPABASE_URL,SUPABASE_ANON_KEY);
let usuario=null,todasConv=[];

document.addEventListener('DOMContentLoaded',async()=>{
  const {data:{session}}=await sb.auth.getSession();
  if(!session){window.location.href='login.html';return;}
  usuario=session.user;
  await carregar();
});

async function carregar(){
  const {data}=await sb.from('conversas').select('*').or(`usuario1.eq.${usuario.id},usuario2.eq.${usuario.id}`).order('data',{ascending:false});
  const demo=[
    {id:1,outro_nome:'Maria Cumbe',outro_avatar:null,ultimo_mensagem:'O produto ainda est√° dispon√≠vel?',data:new Date(Date.now()-300000).toISOString(),nao_lidas:2,produto_id:1},
    {id:2,outro_nome:'Jo√£o Ant√≥nio',outro_avatar:null,ultimo_mensagem:'Muito obrigado pela compra!',data:new Date(Date.now()-3600000).toISOString(),nao_lidas:0,produto_id:2},
    {id:3,outro_nome:'Pedro Matos',outro_avatar:null,ultimo_mensagem:'Aceita MT 60,000?',data:new Date(Date.now()-86400000).toISOString(),nao_lidas:1,produto_id:3},
  ];
  todasConv=(data&&data.length)?data:demo;
  renderizar(todasConv);
}

function renderizar(lista){
  const el=document.getElementById('lista');
  if(!lista.length){el.innerHTML=`<div class="vazio"><div style="font-size:64px;margin-bottom:12px">üí¨</div><p style="font-size:18px;font-weight:700;margin-bottom:8px">Sem conversas ainda</p><a href="index.html" style="display:inline-block;margin-top:12px;background:var(--azul);color:#fff;padding:12px 24px;border-radius:8px;text-decoration:none;font-weight:700">Explorar Produtos</a></div>`;return;}
  el.innerHTML='';
  lista.forEach(c=>{
    const outroId=c.usuario1===usuario.id?c.usuario2:c.usuario1;
    const div=document.createElement('div');
    div.className=`conv-item${(c.nao_lidas||0)>0?' nao-lida':''}`;
    div.onclick=()=>window.location.href=`chat.html?vendedor=${outroId}&produto=${c.produto_id||''}`;
    div.innerHTML=`
      <div class="conv-avatar">${c.outro_avatar?`<img src="${c.outro_avatar}" alt="${c.outro_nome}">`:'üë§'}</div>
      <div class="conv-info">
        <div class="conv-header">
          <span class="conv-nm">${c.outro_nome||`Utilizador`}</span>
          <span class="conv-time">${tempoRelativo(c.data)}</span>
        </div>
        <div style="display:flex;align-items:center">
          <div class="conv-msg ${(c.nao_lidas||0)>0?'bold':''}">${c.ultimo_mensagem||'Sem mensagens'}</div>
          ${(c.nao_lidas||0)>0?`<div class="badge-unread">${c.nao_lidas}</div>`:''}
        </div>
      </div>`;
    el.appendChild(div);
  });
}

function filtrarConversas(q){
  const f=q.toLowerCase();
  renderizar(f?todasConv.filter(c=>(c.outro_nome||'').toLowerCase().includes(f)||(c.ultimo_mensagem||'').toLowerCase().includes(f)):todasConv);
}

function tempoRelativo(data){
  const diff=Date.now()-new Date(data).getTime();
  const min=Math.floor(diff/60000),h=Math.floor(diff/3600000),d=Math.floor(diff/86400000);
  if(min<1)return'Agora';if(min<60)return`${min}m`;if(h<24)return`${h}h`;if(d<7)return`${d}d`;
  return new Date(data).toLocaleDateString('pt-MZ',{day:'2-digit',month:'2-digit'});
}
</script>

<script>
if ("serviceWorker" in navigator) {
  window.addEventListener("load", () => {
    navigator.serviceWorker.register("/service-worker.js")
      .then(r => console.log("[Luvano SW] Registado:", r.scope))
      .catch(e => console.warn("[Luvano SW] Erro:", e));
  });
}
</script>
</body>
</html>
