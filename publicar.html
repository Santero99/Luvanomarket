<!DOCTYPE html>
<html lang="pt-MZ">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Publicar Produto - Luvano</title>
  <link rel="manifest" href="manifest.json"/>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    :root {
      --azul: #1877f2; --azul-dark: #0d5ec9; --azul-light: #e7f0ff;
      --cinza-bg: #f0f2f5; --cinza-borda: #dde1e7; --cinza-card: #fff;
      --texto: #1c1e21; --texto-sec: #65676b; --verde: #25a244;
      --vermelho: #e41e3f; --radius: 12px; --sombra: 0 2px 12px rgba(0,0,0,0.1);
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Segoe UI', system-ui, sans-serif; background: var(--cinza-bg); min-height: 100vh; }
    header { background: var(--azul); padding: 0 20px; height: 60px; display: flex; align-items: center; justify-content: space-between; box-shadow: 0 2px 10px rgba(24,119,242,0.4); }
    header a.logo { color: #fff; font-size: 20px; font-weight: 800; text-decoration: none; }
    .btn-voltar { color: #fff; background: rgba(255,255,255,0.2); border: none; border-radius: 8px; padding: 8px 14px; cursor: pointer; font-size: 14px; text-decoration: none; display: flex; align-items: center; gap: 6px; }
    .container { max-width: 720px; margin: 0 auto; padding: 24px 16px; }
    .page-titulo { font-size: 24px; font-weight: 800; margin-bottom: 4px; }
    .page-sub { color: var(--texto-sec); margin-bottom: 24px; font-size: 15px; }
    .card { background: #fff; border-radius: var(--radius); box-shadow: var(--sombra); padding: 24px; margin-bottom: 16px; }
    .section-titulo { font-size: 16px; font-weight: 700; margin-bottom: 16px; display: flex; align-items: center; gap: 8px; }
    .form-group { margin-bottom: 18px; }
    .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
    label { display: block; font-size: 14px; font-weight: 600; margin-bottom: 6px; }
    label span.obrig { color: var(--vermelho); }
    input[type=text], input[type=number], input[type=tel], textarea, select {
      width: 100%; padding: 12px 14px; border: 2px solid var(--cinza-borda);
      border-radius: 10px; font-size: 15px; outline: none;
      transition: border-color 0.2s; font-family: inherit; color: var(--texto);
    }
    input:focus, textarea:focus, select:focus { border-color: var(--azul); }
    textarea { resize: vertical; min-height: 100px; }

    /* FOTOS UPLOAD */
    .fotos-area { border: 2px dashed var(--cinza-borda); border-radius: 12px; padding: 28px; text-align: center; cursor: pointer; transition: all 0.2s; background: #fafafa; }
    .fotos-area:hover, .fotos-area.drag { border-color: var(--azul); background: var(--azul-light); }
    .fotos-area .icon-upload { font-size: 40px; margin-bottom: 8px; }
    .fotos-area p { color: var(--texto-sec); font-size: 14px; }
    .fotos-area strong { color: var(--azul); }
    #fileInput { display: none; }
    .fotos-preview { display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 12px; margin-top: 16px; }
    .foto-item { position: relative; aspect-ratio: 1; border-radius: 10px; overflow: hidden; background: var(--cinza-bg); }
    .foto-item img { width: 100%; height: 100%; object-fit: cover; }
    .foto-item .remover { position: absolute; top: 4px; right: 4px; background: rgba(0,0,0,0.7); color: #fff; border: none; border-radius: 50%; width: 24px; height: 24px; cursor: pointer; font-size: 14px; display: flex; align-items: center; justify-content: center; }
    .foto-item .principal-badge { position: absolute; bottom: 4px; left: 4px; background: var(--azul); color: #fff; font-size: 10px; font-weight: 700; padding: 2px 6px; border-radius: 4px; }
    .fotos-count { font-size: 12px; color: var(--texto-sec); margin-top: 8px; }

    /* PRE√áO */
    .preco-group { position: relative; }
    .preco-prefix { position: absolute; left: 14px; top: 50%; transform: translateY(-50%); font-weight: 700; color: var(--texto-sec); }
    .preco-group input { padding-left: 46px; }

    /* CONDI√á√ÉO */
    .condicao-btns { display: flex; gap: 10px; }
    .cond-btn { flex: 1; padding: 10px; border: 2px solid var(--cinza-borda); border-radius: 10px; background: #fff; cursor: pointer; text-align: center; font-size: 14px; font-weight: 600; transition: all 0.2s; }
    .cond-btn.ativo { border-color: var(--azul); background: var(--azul-light); color: var(--azul); }

    /* ENTREGA */
    .entrega-opts { display: flex; gap: 10px; flex-wrap: wrap; }
    .entrega-opt { display: flex; align-items: center; gap: 6px; padding: 8px 14px; border: 2px solid var(--cinza-borda); border-radius: 8px; cursor: pointer; font-size: 14px; transition: all 0.2s; }
    .entrega-opt.ativo { border-color: var(--verde); background: #e8f5e9; color: var(--verde); }
    .entrega-opt input { display: none; }

    /* BOT√ÉO */
    .btn-publicar { width: 100%; background: var(--azul); color: #fff; border: none; border-radius: 10px; padding: 16px; font-size: 17px; font-weight: 700; cursor: pointer; transition: background 0.2s; display: flex; align-items: center; justify-content: center; gap: 10px; }
    .btn-publicar:hover { background: var(--azul-dark); }
    .btn-publicar:disabled { background: #9fb8e8; cursor: not-allowed; }
    .spinner { width: 22px; height: 22px; border: 3px solid rgba(255,255,255,0.4); border-top-color: #fff; border-radius: 50%; animation: spin 0.6s linear infinite; display: none; }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* PROGRESSO UPLOAD */
    .prog-wrap { margin-top: 12px; display: none; }
    .prog-bar { height: 6px; background: var(--cinza-borda); border-radius: 6px; overflow: hidden; }
    .prog-fill { height: 100%; background: var(--azul); width: 0; transition: width 0.3s; border-radius: 6px; }
    .prog-txt { font-size: 12px; color: var(--texto-sec); margin-top: 4px; }

    #toast { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%) translateY(80px); background: #323232; color: #fff; padding: 12px 24px; border-radius: 30px; font-size: 14px; z-index: 9999; transition: transform 0.3s; }
    #toast.show { transform: translateX(-50%) translateY(0); }

    @media (max-width: 600px) { .form-row { grid-template-columns: 1fr; } }
  </style>
</head>
<body>
<header>
  <a class="logo" href="index.html">üõçÔ∏è Luvano</a>
  <a href="index.html" class="btn-voltar">‚Üê Voltar</a>
</header>

<div class="container">
  <div class="page-titulo">üì∏ Publicar Produto</div>
  <div class="page-sub">Adicione as informa√ß√µes e fotos do seu produto</div>

  <!-- FOTOS -->
  <div class="card">
    <div class="section-titulo">üì∑ Fotos do Produto</div>
    <div class="fotos-area" id="fotosArea" onclick="document.getElementById('fileInput').click()" ondrop="dropFoto(event)" ondragover="dragOver(event)" ondragleave="dragLeave(event)">
      <div class="icon-upload">üñºÔ∏è</div>
      <p><strong>Clique ou arraste as fotos aqui</strong></p>
      <p>At√© 10 fotos ¬∑ JPG, PNG, WEBP ¬∑ Max 5MB cada</p>
    </div>
    <input type="file" id="fileInput" multiple accept="image/*" onchange="adicionarFotos(this.files)" />
    <div class="fotos-preview" id="fotosPreview"></div>
    <div class="fotos-count" id="fotosCount"></div>
    <div class="prog-wrap" id="progWrap">
      <div class="prog-bar"><div class="prog-fill" id="progFill"></div></div>
      <div class="prog-txt" id="progTxt">A carregar fotos...</div>
    </div>
  </div>

  <!-- INFORMA√á√ïES B√ÅSICAS -->
  <div class="card">
    <div class="section-titulo">üìã Informa√ß√µes B√°sicas</div>
    <div class="form-group">
      <label>T√≠tulo do Produto <span class="obrig">*</span></label>
      <input type="text" id="nome" placeholder="Ex: iPhone 14 Pro 256GB Preto" maxlength="80" oninput="contarCaracteres()" />
      <div style="text-align:right;font-size:12px;color:var(--texto-sec);margin-top:3px"><span id="nomeCount">0</span>/80</div>
    </div>
    <div class="form-group">
      <label>Descri√ß√£o <span class="obrig">*</span></label>
      <textarea id="descricao" placeholder="Descreva o produto em detalhes: estado, especifica√ß√µes, motivo da venda..."></textarea>
    </div>
    <div class="form-row">
      <div class="form-group">
        <label>Categoria <span class="obrig">*</span></label>
        <select id="categoria">
          <option value="">Selecionar categoria</option>
          <option value="electrodomesticos">üì± Electr√≥nica</option>
          <option value="veiculos">üöó Ve√≠culos</option>
          <option value="imoveis">üè° Im√≥veis</option>
          <option value="moda">üëó Moda</option>
          <option value="moveis">ü™ë M√≥veis</option>
          <option value="alimentacao">üçé Alimenta√ß√£o</option>
          <option value="servicos">üîß Servi√ßos</option>
          <option value="animais">üêæ Animais</option>
          <option value="desporto">‚öΩ Desporto</option>
          <option value="outros">üì¶ Outros</option>
        </select>
      </div>
      <div class="form-group">
        <label>Localiza√ß√£o <span class="obrig">*</span></label>
        <select id="local">
          <option value="">Selecionar cidade</option>
          <option value="Maputo, Cidade">Maputo - Cidade</option>
          <option value="Maputo, Matola">Matola</option>
          <option value="Beira">Beira</option>
          <option value="Nampula">Nampula</option>
          <option value="Quelimane">Quelimane</option>
          <option value="Tete">Tete</option>
          <option value="Chimoio">Chimoio</option>
          <option value="Nacala">Nacala</option>
          <option value="Pemba">Pemba</option>
          <option value="Lichinga">Lichinga</option>
          <option value="Xai-Xai">Xai-Xai</option>
          <option value="Inhambane">Inhambane</option>
        </select>
      </div>
    </div>
    <div class="form-group">
      <label>Condi√ß√£o</label>
      <div class="condicao-btns">
        <div class="cond-btn ativo" onclick="selCondicao('novo', this)">‚ú® Novo</div>
        <div class="cond-btn" onclick="selCondicao('seminovo', this)">üëç Semi-Novo</div>
        <div class="cond-btn" onclick="selCondicao('usado', this)">üì¶ Usado</div>
      </div>
    </div>
  </div>

  <!-- PRE√áO -->
  <div class="card">
    <div class="section-titulo">üí∞ Pre√ßo e Negocia√ß√£o</div>
    <div class="form-row">
      <div class="form-group">
        <label>Pre√ßo (MT) <span class="obrig">*</span></label>
        <div class="preco-group">
          <span class="preco-prefix">MT</span>
          <input type="number" id="preco" placeholder="0.00" min="0" step="0.01" />
        </div>
      </div>
      <div class="form-group">
        <label>Tipo de Pre√ßo</label>
        <select id="tipoPreco">
          <option value="fixo">Pre√ßo Fixo</option>
          <option value="negociavel">Negoci√°vel</option>
          <option value="permuta">Permuta</option>
          <option value="gratis">Gr√°tis</option>
        </select>
      </div>
    </div>
    <div class="form-group">
      <label>Formas de Entrega</label>
      <div class="entrega-opts">
        <div class="entrega-opt ativo" onclick="toggleEntrega(this, 'presencial')">
          ü§ù Presencial
        </div>
        <div class="entrega-opt" onclick="toggleEntrega(this, 'entrega')">
          üöö Entrega ao Domic√≠lio
        </div>
        <div class="entrega-opt" onclick="toggleEntrega(this, 'motoboy')">
          üèçÔ∏è Motoboy
        </div>
      </div>
    </div>
  </div>

  <!-- CONTACTO -->
  <div class="card">
    <div class="section-titulo">üìû Contacto</div>
    <div class="form-group">
      <label>WhatsApp para Contacto <span class="obrig">*</span></label>
      <input type="tel" id="whatsapp" placeholder="+258 84 123 4567" />
      <div style="font-size:12px;color:var(--texto-sec);margin-top:4px">
        üí° Os compradores ir√£o contactar-lhe via WhatsApp
      </div>
    </div>
  </div>

  <button class="btn-publicar" onclick="publicarProduto()" id="btnPublicar">
    üöÄ Publicar Produto <div class="spinner" id="spin"></div>
  </button>
</div>

<div id="toast"></div>

<script>
const SUPABASE_URL = 'https://SEU_PROJETO.supabase.co';
const SUPABASE_ANON_KEY = 'SUA_ANON_KEY_AQUI';
const { createClient } = supabase;
const sb = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

let fotosFiles = [];
let fotosUrls = [];
let condicao = 'novo';
let entregas = ['presencial'];
let usuario = null;

document.addEventListener('DOMContentLoaded', async () => {
  const { data: { session } } = await sb.auth.getSession();
  if (!session) {
    mostrarToast('Fa√ßa login para publicar produtos');
    setTimeout(() => window.location.href = 'login.html?next=publicar.html', 1500);
    return;
  }
  usuario = session.user;
  // Pr√©-preencher WhatsApp com dados do perfil
  const { data: perfil } = await sb.from('users').select('telefone').eq('id', usuario.id).single();
  if (perfil?.telefone) document.getElementById('whatsapp').value = perfil.telefone;
});

// Adicionar fotos
function adicionarFotos(files) {
  Array.from(files).forEach(file => {
    if (fotosFiles.length >= 10) { mostrarToast('M√°ximo 10 fotos por produto', 'erro'); return; }
    if (file.size > 5 * 1024 * 1024) { mostrarToast(`${file.name} √© muito grande (m√°x 5MB)`, 'erro'); return; }
    fotosFiles.push(file);
    const reader = new FileReader();
    reader.onload = e => adicionarPreview(e.target.result, fotosFiles.length - 1);
    reader.readAsDataURL(file);
  });
  atualizarCount();
}

function adicionarPreview(src, idx) {
  const preview = document.getElementById('fotosPreview');
  const div = document.createElement('div');
  div.className = 'foto-item';
  div.id = `foto-${idx}`;
  div.innerHTML = `
    <img src="${src}" alt="Foto ${idx+1}" />
    ${idx === 0 ? '<span class="principal-badge">Principal</span>' : ''}
    <button class="remover" onclick="removerFoto(${idx})">‚úï</button>
  `;
  preview.appendChild(div);
}

function removerFoto(idx) {
  fotosFiles.splice(idx, 1);
  document.getElementById(`foto-${idx}`)?.remove();
  atualizarCount();
}

function atualizarCount() {
  const n = fotosFiles.length;
  document.getElementById('fotosCount').textContent = n > 0 ? `${n}/10 fotos adicionadas` : '';
}

// Drag and drop
function dragOver(e) {
  e.preventDefault();
  document.getElementById('fotosArea').classList.add('drag');
}
function dragLeave() {
  document.getElementById('fotosArea').classList.remove('drag');
}
function dropFoto(e) {
  e.preventDefault();
  dragLeave();
  adicionarFotos(e.dataTransfer.files);
}

// Condi√ß√£o
function selCondicao(val, el) {
  condicao = val;
  document.querySelectorAll('.cond-btn').forEach(b => b.classList.remove('ativo'));
  el.classList.add('ativo');
}

// Entrega
function toggleEntrega(el, val) {
  el.classList.toggle('ativo');
  if (el.classList.contains('ativo')) { entregas.push(val); }
  else { entregas = entregas.filter(e => e !== val); }
}

function contarCaracteres() {
  document.getElementById('nomeCount').textContent = document.getElementById('nome').value.length;
}

// Publicar produto
async function publicarProduto() {
  const nome = document.getElementById('nome').value.trim();
  const descricao = document.getElementById('descricao').value.trim();
  const categoria = document.getElementById('categoria').value;
  const local = document.getElementById('local').value;
  const preco = parseFloat(document.getElementById('preco').value);
  const tipoPreco = document.getElementById('tipoPreco').value;
  const whatsapp = document.getElementById('whatsapp').value.trim();

  if (!nome) { mostrarToast('Insira o t√≠tulo do produto', 'erro'); return; }
  if (!descricao) { mostrarToast('Insira a descri√ß√£o', 'erro'); return; }
  if (!categoria) { mostrarToast('Selecione uma categoria', 'erro'); return; }
  if (!local) { mostrarToast('Selecione a localiza√ß√£o', 'erro'); return; }
  if (!preco && tipoPreco !== 'gratis') { mostrarToast('Insira o pre√ßo', 'erro'); return; }
  if (!whatsapp) { mostrarToast('Insira o n√∫mero de WhatsApp', 'erro'); return; }
  if (fotosFiles.length === 0) { mostrarToast('Adicione pelo menos 1 foto', 'erro'); return; }

  setLoading(true);

  try {
    // Upload fotos para Supabase Storage
    const progWrap = document.getElementById('progWrap');
    const progFill = document.getElementById('progFill');
    const progTxt = document.getElementById('progTxt');
    progWrap.style.display = 'block';

    const fotosUpload = [];
    for (let i = 0; i < fotosFiles.length; i++) {
      const file = fotosFiles[i];
      const ext = file.name.split('.').pop();
      const path = `produtos/${usuario.id}/${Date.now()}_${i}.${ext}`;
      
      const { error: upErr } = await sb.storage.from('luvano-fotos').upload(path, file, { upsert: true });
      if (upErr) throw upErr;

      const { data: url } = sb.storage.from('luvano-fotos').getPublicUrl(path);
      fotosUpload.push(url.publicUrl);

      const pct = Math.round(((i + 1) / fotosFiles.length) * 100);
      progFill.style.width = pct + '%';
      progTxt.textContent = `A carregar foto ${i+1}/${fotosFiles.length}...`;
    }

    // Inserir produto na BD
    const { data: prod, error: prodErr } = await sb.from('produtos').insert({
      nome, descricao, categoria, local,
      preco: tipoPreco === 'gratis' ? 0 : preco,
      tipo_preco: tipoPreco,
      fotos: JSON.stringify(fotosUpload),
      total_fotos: fotosUpload.length,
      condicao,
      entregas: JSON.stringify(entregas),
      vendedor_id: usuario.id,
      vendedor_tel: whatsapp.replace(/\D/g, ''),
      ativo: true,
      avaliacao: 0,
      total_avaliacoes: 0,
      criado_em: new Date().toISOString()
    }).select().single();

    if (prodErr) throw prodErr;

    setLoading(false);
    progWrap.style.display = 'none';
    mostrarToast('Produto publicado com sucesso! üéâ', 'sucesso');
    setTimeout(() => window.location.href = `produto.html?id=${prod.id}`, 1500);

  } catch (err) {
    setLoading(false);
    console.error(err);
    mostrarToast('Erro ao publicar: ' + err.message, 'erro');
  }
}

function setLoading(on) {
  document.getElementById('btnPublicar').disabled = on;
  document.getElementById('spin').style.display = on ? 'block' : 'none';
}

function mostrarToast(msg, tipo = 'info') {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.style.background = tipo === 'erro' ? '#c62828' : tipo === 'sucesso' ? '#2e7d32' : '#323232';
  t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 3500);
}
</script>

<script>
if ("serviceWorker" in navigator) {
  window.addEventListener("load", () => {
    navigator.serviceWorker.register("/service-worker.js")
      .then(r => console.log("[Luvano SW] Registado:", r.scope))
      .catch(e => console.warn("[Luvano SW] Erro:", e));
  });
}
</script>
</body>
</html>
