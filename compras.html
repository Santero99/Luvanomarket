<!DOCTYPE html>
<html lang="pt-MZ">
<head>
  <meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Minhas Compras - Luvano</title>
  <link rel="manifest" href="manifest.json"/>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    :root{--azul:#1877f2;--azul-light:#e7f0ff;--cinza-bg:#f0f2f5;--cinza-borda:#dde1e7;--texto:#1c1e21;--texto-sec:#65676b;--verde:#2e7d32;--vermelho:#e41e3f;}
    *{margin:0;padding:0;box-sizing:border-box;}
    body{font-family:'Segoe UI',system-ui,sans-serif;background:var(--cinza-bg);}
    header{background:var(--azul);padding:0 20px;height:60px;display:flex;align-items:center;justify-content:space-between;}
    header a.logo{color:#fff;font-size:20px;font-weight:800;text-decoration:none;}
    .btn-h{color:#fff;background:rgba(255,255,255,.2);border:none;border-radius:8px;padding:8px 14px;cursor:pointer;text-decoration:none;font-size:14px;}
    .container{max-width:780px;margin:0 auto;padding:24px 16px;}
    .page-titulo{font-size:22px;font-weight:800;margin-bottom:4px;}
    .page-sub{color:var(--texto-sec);font-size:14px;margin-bottom:20px;}
    .compra-card{background:#fff;border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,.08);padding:16px;margin-bottom:12px;display:flex;gap:14px;align-items:center;}
    .compra-card img{width:80px;height:80px;border-radius:10px;object-fit:cover;flex-shrink:0;}
    .compra-info{flex:1;}
    .compra-nm{font-weight:700;font-size:16px;margin-bottom:4px;}
    .compra-meta{font-size:13px;color:var(--texto-sec);margin-bottom:6px;}
    .compra-ref{font-size:11px;color:var(--texto-sec);font-family:monospace;background:var(--cinza-bg);padding:2px 8px;border-radius:4px;}
    .compra-val{font-size:22px;font-weight:900;color:var(--azul);white-space:nowrap;}
    .badge{padding:4px 12px;border-radius:20px;font-size:11px;font-weight:700;}
    .b-ok{background:#e8f5e9;color:var(--verde);}
    .b-pend{background:#fff3e0;color:#ef6c00;}
    .compra-acoes{display:flex;gap:8px;margin-top:8px;flex-wrap:wrap;}
    .btn-mini{padding:7px 14px;border-radius:7px;font-size:12px;font-weight:600;cursor:pointer;border:none;text-decoration:none;}
    .btn-ver{background:var(--azul-light);color:var(--azul);}
    .btn-wa{background:#25D366;color:#fff;}
    .vazio{text-align:center;padding:80px 24px;color:var(--texto-sec);}
    #toast{position:fixed;bottom:20px;left:50%;transform:translateX(-50%) translateY(80px);background:#323232;color:#fff;padding:12px 24px;border-radius:30px;font-size:14px;z-index:9999;transition:transform .3s;}
    #toast.show{transform:translateX(-50%) translateY(0);}
  </style>
</head>
<body>
<header>
  <a class="logo" href="index.html">üõçÔ∏è Luvano</a>
  <a href="index.html" class="btn-h">üè† In√≠cio</a>
</header>
<div class="container">
  <div class="page-titulo">üì¶ Minhas Compras</div>
  <div class="page-sub" id="countSub">A carregar...</div>
  <div id="lista"><div style="text-align:center;padding:40px;color:var(--texto-sec)">A carregar...</div></div>
</div>
<div id="toast"></div>
<script>
const SUPABASE_URL='https://SEU_PROJETO.supabase.co';
const SUPABASE_ANON_KEY='SUA_ANON_KEY_AQUI';
const {createClient}=supabase;
const sb=createClient(SUPABASE_URL,SUPABASE_ANON_KEY);
let usuario=null;

document.addEventListener('DOMContentLoaded',async()=>{
  const {data:{session}}=await sb.auth.getSession();
  if(!session){window.location.href='login.html?next=compras.html';return;}
  usuario=session.user;
  await carregar();
});

async function carregar(){
  const {data}=await sb.from('pagamentos').select('*,produtos(nome,fotos,preco,vendedor_tel)').eq('usuario_id',usuario.id).order('criado_em',{ascending:false});
  const lista=document.getElementById('lista');
  const demo=[
    {id:'LVN123',referencia:'LVNABC123',status:'confirmado',metodo:'mpesa',valor:65000,criado_em:new Date(Date.now()-86400000).toISOString(),produtos:{nome:'iPhone 14 Pro 256GB',fotos:'["https://images.unsplash.com/photo-1695048133142-1a20484d2569?w=80&q=80"]',preco:65000,vendedor_tel:'258841234567'}},
    {id:'LVN456',referencia:'LVNDEF456',status:'pendente',metodo:'emola',valor:18500,criado_em:new Date(Date.now()-172800000).toISOString(),produtos:{nome:'Sof√° 3 Lugares',fotos:'["https://images.unsplash.com/photo-1555041469-a586c61ea9bc?w=80&q=80"]',preco:18500,vendedor_tel:'258842345678'}},
  ];
  const compras=(data&&data.length)?data:demo;
  document.getElementById('countSub').textContent=`${compras.length} compra${compras.length!==1?'s':''}`;
  if(!compras.length){lista.innerHTML=`<div class="vazio"><div style="font-size:64px;margin-bottom:12px">üõí</div><p style="font-size:18px;font-weight:700;margin-bottom:8px">Nenhuma compra ainda</p><a href="index.html" style="display:inline-block;margin-top:16px;background:var(--azul);color:#fff;padding:12px 24px;border-radius:8px;text-decoration:none;font-weight:700">Explorar Produtos</a></div>`;return;}
  lista.innerHTML='';
  compras.forEach(c=>{
    const p=c.produtos||{};
    const fotos=typeof p.fotos==='string'?JSON.parse(p.fotos):(p.fotos||[]);
    const tel=(p.vendedor_tel||'').replace(/\D/g,'');
    const msg=encodeURIComponent(`Ol√°! Comprei o produto "${p.nome}" no Luvano (ref: ${c.referencia||c.id}). Preciso de ajuda.`);
    const card=document.createElement('div');
    card.className='compra-card';
    card.innerHTML=`
      <img src="${fotos[0]||'https://via.placeholder.com/80'}" alt="${p.nome}" onerror="this.src='https://via.placeholder.com/80'" onclick="window.location.href='produto.html?id=${c.produto_id}'" style="cursor:pointer"/>
      <div class="compra-info">
        <div class="compra-nm">${p.nome||'Produto'}</div>
        <div class="compra-meta">${(c.metodo||'').toUpperCase()} ¬∑ ${new Date(c.criado_em).toLocaleDateString('pt-MZ',{day:'2-digit',month:'short',year:'numeric'})}</div>
        <span class="compra-ref">Ref: ${c.referencia||c.id}</span>
        <div class="compra-acoes">
          <span class="badge ${c.status==='confirmado'?'b-ok':'b-pend'}">${c.status==='confirmado'?'‚úÖ Confirmado':'‚è≥ Pendente'}</span>
          <a href="produto.html?id=${c.produto_id}" class="btn-mini btn-ver">Ver Produto</a>
          ${tel?`<a href="https://wa.me/${tel}?text=${msg}" target="_blank" class="btn-mini btn-wa">üìû WhatsApp</a>`:''}
        </div>
      </div>
      <div class="compra-val">MT ${Number(c.valor||p.preco||0).toLocaleString('pt-MZ')}</div>`;
    lista.appendChild(card);
  });
}
</script>

<script>
if ("serviceWorker" in navigator) {
  window.addEventListener("load", () => {
    navigator.serviceWorker.register("/service-worker.js")
      .then(r => console.log("[Luvano SW] Registado:", r.scope))
      .catch(e => console.warn("[Luvano SW] Erro:", e));
  });
}
</script>
</body>
</html>
